# Changelog

All notable changes to the WDM AI BotKit Extension will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Fixed
- **Critical Metadata Consistency**: Fixed major inconsistencies in migration system metadata structure
  - Migration now includes ALL metadata fields from normal plugin flow (source, mime_type, extension, size, original_size, last_modified, total_chunks, has_previous, has_next, has_overlap_prev, has_overlap_next)
  - Fixed data type inconsistencies (integers vs strings for chunk_index, document_id, post_id)
  - Corrected source identification (now uses 'post' instead of 'migration' for WordPress posts)
  - Added complete chunk relationship tracking for proper context retrieval
  - Migration data now matches normal plugin flow exactly, ensuring consistent retrieval behavior
  - Fixed Pinecone to Local migration to preserve complete metadata structure
  - Added metadata reconstruction helper to ensure all fields are properly populated
- **System-Wide Inconsistencies**: Resolved multiple system inconsistencies and redundancies
  - Removed orphaned configuration options (ai_botkit_queue_batch_size, ai_botkit_embeddings_cache_ttl, ai_botkit_rate_limit, ai_botkit_rate_window, ai_botkit_wc_enabled, ai_botkit_analytics_enabled, ai_botkit_backup_enabled)
  - Added missing configuration options (ai_botkit_max_requests_per_day, ai_botkit_post_types) to activator
  - Centralized batch size configuration across system (now uses single ai_botkit_batch_size option)
  - Removed duplicate CSS definitions for .ai-botkit-btn-danger (consolidated in admin.css)
  - Standardized error logging format across all components (consistent "AI BotKit [Component] Error: [Description] - [Message]" format)
  - Removed commented debug code from production files (Public AJAX Handler, Rate Limiter)
  - Unified migration tracking to use consistent metadata storage (both directions now use migration_source and migration_timestamp)
  - Added server-side validation for clear database operations (validates Pinecone configuration)
  - Display previously unused migration status fields (migration_in_progress, last_migration) to users
  - Enhanced migration status UI with real-time progress and history information
- **Enhanced Alert & Confirmation System**: Comprehensive improvements to user notifications and confirmations
  - Replaced all native alert() and confirm() calls with modern SweetAlert2 modals
  - Enhanced toast notification system with rich content, actions, and progress indicators
  - Added smart confirmations with undo capabilities for destructive actions
  - Implemented batch operation confirmations with item previews
  - Added comprehensive accessibility support (ARIA labels, keyboard navigation, screen reader announcements)
  - Enhanced mobile responsiveness with touch-friendly interactions
  - Added dark mode and high contrast support
  - Implemented reduced motion support for accessibility
  - Added progress indicators for long-running operations like migrations
  - Enhanced error handling with detailed, actionable error messages
  - Improved visual design with modern gradients, shadows, and animations
- **Improved Database Clearing Functionality**: Enhanced database management with granular clearing options
  - Fixed "Clear Local Database" to only clear vector data (chunks & embeddings) while preserving document metadata
  - Added separate "Clear Knowledge Base" button for complete knowledge base removal
  - Updated UI labels to be more descriptive about what each clear operation does
  - Added tooltips explaining the impact of each clearing operation
  - Enhanced confirmation dialogs with detailed descriptions of what will be affected
  - Knowledge base display now remains functional after clearing vector data
  - Users can now selectively clear vector data without losing document associations
- **System-Wide Consistency Fixes**: Addressed multiple inconsistencies and redundancies across the codebase
  - **CRITICAL**: Implemented missing Pinecone clear functionality with proper API integration
  - **CRITICAL**: Fixed duplicate AJAX action registrations that could cause conflicts
  - **HIGH**: Standardized configuration options between settings form and default values
  - **MEDIUM**: Cleaned up CSS class redundancies and consolidated duplicate definitions
  - **MEDIUM**: Removed commented-out code blocks and dead code
  - **MEDIUM**: Addressed TODO comments in production code with proper error messages
  - **MEDIUM**: Improved error messages for unsupported file formats (DOCX)
  - **MEDIUM**: Enhanced Google AI API connection testing with proper endpoint usage
  - **LOW**: Consolidated form styling and button definitions for consistency
- **Additional System-Wide Consistency Fixes**: Addressed remaining inconsistencies and redundancies
  - **HIGH**: Fixed duplicate admin hook registrations that could cause conflicts
  - **HIGH**: Resolved CSS button definition conflicts between admin.css and migration-wizard.css
  - **MEDIUM**: Standardized array syntax across all files for consistency
  - **MEDIUM**: Cleaned up commented integration classes and dead code
  - **MEDIUM**: Fixed version inconsistency between plugin header and constants
  - **LOW**: Removed orphaned documentation files (CONSISTENCY_SUMMARY.md, consistency-check.php)
  - **LOW**: Audited and removed unused CSS classes (topbar, hamburger menu)
  - **LOW**: Verified error handling patterns are already standardized
  - **LOW**: Improved code organization and maintainability
- **Automatic Chunk Cleanup on Post Updates**: Implemented intelligent cleanup system
  - **CRITICAL**: Added automatic deletion of old chunks when posts are updated
  - **CRITICAL**: Enhanced vector database to handle document-level cleanup for both local and Pinecone
  - **CRITICAL**: Modified RAG engine to detect updates and clean up old data before processing new content
  - **HIGH**: Added comprehensive cleanup logging for monitoring and debugging
  - **HIGH**: Implemented proper error handling for cleanup operations
  - **MEDIUM**: Enhanced Pinecone integration to support selective vector deletion
  - **MEDIUM**: Added document existence checking to determine if cleanup is needed
  - **LOW**: Improved cache management during cleanup operations
- **LearnDash Course Sync Feature**: Added comprehensive sync functionality for existing courses
  - **CRITICAL**: Added sync button in extension license page for reprocessing existing LearnDash courses
  - **CRITICAL**: Implemented batch processing system to handle large numbers of courses efficiently
  - **HIGH**: Added real-time progress tracking with visual progress bar and status updates
  - **HIGH**: Implemented comprehensive course content building (lessons, topics, quizzes, metadata)
  - **HIGH**: Added error handling and reporting for failed course syncs
  - **MEDIUM**: Integrated with existing RAG engine cleanup system for seamless reprocessing
  - **MEDIUM**: Added AJAX-based sync process with nonce security and permission checks
  - **LOW**: Enhanced UI with detailed sync results and error reporting
- **Automatic Content Transformation System**: Implemented intelligent content management based on license status
  - **CRITICAL**: Added automatic content downgrade when extension license expires or is deactivated
  - **CRITICAL**: Implemented content upgrade system when license is reactivated
  - **HIGH**: Added license status monitoring with automatic event triggering
  - **HIGH**: Created content transformer engine for seamless content level management
  - **HIGH**: Implemented comprehensive LearnDash content downgrade (lessons, topics, quizzes â†’ title + description)
  - **HIGH**: Added automatic embedding regeneration for transformed content
  - **MEDIUM**: Enhanced sync button to show upgrade status and appropriate messaging
  - **MEDIUM**: Added user notifications for content transformation events
  - **LOW**: Implemented upgrade completion tracking and status display

### Added
- **Advanced Content Change Detection**: Implemented intelligent content change detection system
  - Content hash comparison to detect actual changes before processing
  - Automatic content hash caching in post meta for efficient comparison
  - Prevents unnecessary processing of unchanged content
  - Significant performance improvement for content updates
- **Automatic Post Update System**: Enhanced WordPress content integration with automatic updates
  - Real-time content synchronization when posts are updated
  - Priority-based processing queue (high, normal, low priority)
  - Smart content type prioritization (courses, products, pages get high priority)
  - Background processing for large content to avoid blocking user actions
- **Database Migration System**: Comprehensive migration tools for switching between databases
  - Migration wizard with step-by-step guided process
  - Support for migrating data between local database and Pinecone
  - Granular migration options (all data, by content type, by date range)
  - Progress tracking and error handling during migration
  - Data validation and backup capabilities before migration
- **Rate Limiting System**: Advanced rate limiting for content processing and API calls
  - Per-minute and per-hour rate limits for content processing
  - Error rate monitoring with automatic throttling
  - User-specific and system-wide rate limiting
  - API call rate limiting to respect provider limits
  - Configurable rate limits through admin settings
- **Migration Wizard UI**: User-friendly migration interface in Knowledge Base tab
  - Step-by-step migration wizard with progress indicators
  - Real-time status display for both local and Pinecone databases
  - Content type selection with item counts
  - Date range selection for selective migration
  - Migration confirmation with backup warnings
  - Progress tracking with detailed logging
  - Integrated into Knowledge Base tab for better organization
- **Enhanced Monitoring & Status**: Comprehensive monitoring and status indicators
  - Real-time sync status for both databases
  - Processing queue status and statistics
  - Error tracking and reporting
  - Performance metrics and health checks
  - Visual status badges and progress indicators
- **Advanced Error Handling**: Robust error handling and retry mechanisms
  - Automatic retry with exponential backoff for failed operations
  - Comprehensive error logging and reporting
  - Graceful degradation when services are unavailable
  - User-friendly error messages with suggested solutions
  - Error rate monitoring and automatic throttling
- **Content Hash Caching**: Advanced caching system for performance optimization
  - Content hash caching to avoid redundant processing
  - Embedding cache for frequently accessed vectors
  - Metadata cache for document relationships
  - Transient-based caching with automatic expiration
  - Cache invalidation on content updates
- **Pinecone Toggle Option**: Added user-configurable checkbox to enable/disable Pinecone vector database
  - Users can now choose between Pinecone cloud storage or local WordPress database
  - Checkbox appears above Pinecone API settings in admin panel
  - JavaScript functionality to show/hide Pinecone fields based on checkbox state
  - Automatic fallback to local storage when Pinecone is disabled or misconfigured
  - Improved user control over vector storage preferences
- **SweetAlert Integration for Public Chat**: Added SweetAlert2 library to public chat interface
  - Modern confirmation dialogs for clear conversation functionality
  - Proper z-index layering to appear above chatbot window
  - Prevents interference with chatbot functionality
  - Consistent styling with admin interface confirmations
- **Dynamic Dashboard Content**: Enhanced dashboard to intelligently display content based on existing chatbots
  - Dashboard now checks for existing chatbots and shows appropriate content
  - Shows "Manage your chatbots" when chatbots exist instead of "Create your first chatbot"
  - Displays chatbot count and appropriate messaging based on user's current setup
  - Button text changes from "Create Your First Chatbot" to "Manage Chatbots" when appropriate
  - Maintains "Create Your First Chatbot" for new users without chatbots

### Fixed
- **Dashboard Inconsistency**: Fixed hardcoded "Create your first chatbot" message showing even when chatbots exist
  - Dashboard now dynamically adapts content based on actual chatbot data
  - Eliminates confusion for users who already have chatbots configured
  - Provides better user experience with contextually appropriate messaging
- **Debug Statement Cleanup**: Removed all debugging statements from extension and core plugin
  - Cleaned up error_log statements from WDM extension admin class
  - Removed debug logging from core AI BotKit admin class
  - Cleaned up debug statements from sidebar view
  - Production-ready code without development debugging artifacts
- **License Validation Logic**: Fixed periodic license validation to prevent unnecessary license invalidation
  - Only update local status if remote validation succeeds and status actually changed
  - Don't invalidate license on network errors or server failures
  - Improved validation timing to be less aggressive
  - Corrected remote response field name from `license_status` to `license`
  - Added proper handling for `deactivated` status value from remote server
- **Notice Display System**: Fixed double notices and improved notice logic
  - Show notices only when there are actual issues (not when everything is working)
  - Removed conflicting static vs dynamic status displays
  - Improved notice hierarchy and context awareness
  - Added support for `deactivated` status in notice logic
  - Enhanced screen detection to disable notices only on AI BotKit extension-license tab page
  - Precise detection using page and tab parameters for targeted notice suppression
- **AJAX Flow Optimization**: Streamlined license management AJAX calls
  - Removed redundant status update AJAX call
  - Return updated status directly from license actions
  - Eliminated unnecessary AJAX requests
- **UI Consistency**: Fixed license status display conflicts
  - Made settings page display fully dynamic
  - Removed static status elements that conflicted with AJAX updates
  - Improved status update flow for both main plugin and extension licenses
  - Added proper display handling for `deactivated` license status
- **Main Plugin License Dependencies**: Removed all main plugin license checking functionality
  - Eliminated double notices caused by main plugin license checks
  - Simplified license system to focus only on extension licensing
  - Removed unnecessary dependencies on main plugin licensing
  - Cleaner user interface with only relevant extension license information
- **Plugin Dependency Management**: Added proper dependency checking and user feedback
- **SweetAlert Z-Index Fix**: Fixed SweetAlert popup appearing behind chatbot window
  - Added custom CSS classes for proper layering
  - Set z-index to 99999 to appear above chatbot (z-index: 9999)
  - Prevented popup clicks from interfering with chatbot functionality
  - Added backdrop and proper event handling configuration
  - Prevents extension activation when AI BotKit plugin is not active
  - Shows clear error message during activation if dependency is missing
  - Displays admin notice when plugin is active but dependency is missing
  - Graceful handling of missing dependencies without breaking functionality
  - Robust plugin detection using WordPress plugin functions instead of class checks
  - Handles folder name changes and plugin structure variations
- **User Interface Improvements**: Enhanced user experience with modern UI elements
  - Replaced browser alerts with elegant toast notifications
  - Moved inline styles to dedicated CSS file for better maintainability
  - Moved inline JavaScript to dedicated JS file for better organization
  - Added smooth animations and transitions for better user feedback
  - Improved form handling with proper loading states and error handling
- **JavaScript and AJAX Fixes**: Resolved JavaScript errors and improved functionality
  - Fixed undefined function errors by removing obsolete function calls
  - Added proper AJAX localization for JavaScript variables
  - Fixed form submission and error handling
  - Improved toast notification system integration
  - Fixed AJAX variable localization by moving it to enqueue_scripts method
- **License Validation Logic**: Fixed license validation and scheduling issues
  - Fixed remote response field mapping to handle different server response structures
  - Improved activation validation to check actual license status from remote response
  - Prevented periodic validation from running when license is not activated
  - Added proper schedule clearing when license becomes invalid
  - Enhanced error handling for network and server failures
- **AJAX Form Handling**: Fixed form field name mismatch in license activation
  - Corrected AJAX handler to use proper form field name `wdm_ai_botkit_extension_license_key`
  - Fixed PHP warning about undefined array key in license processing
  - Ensured proper license key extraction from form submission
- **Chatbot Property Validation**: Fixed PHP warnings about undefined properties in chatbot display
  - Added validation for JSON-decoded style and model_config objects
  - Set default values for missing properties (primary_color, avatar, tone)
  - Prevents PHP warnings when chatbot data is incomplete or corrupted
  - Ensures consistent display even with incomplete database records
  - Added proper escaping for style properties (esc_attr for CSS values)
- **Public Template Array Key Validation**: Fixed undefined array key warnings in public templates
  - Added null coalescing operators for style properties in shortcode handler
  - Set default values for missing style properties (header_icon_color, background_image, theme, enable_gradient)
  - Added array validation and defaults in widget.php and chat.php templates
  - Prevents PHP warnings when chatbot style data is incomplete
  - Ensures graceful fallback to default values for missing properties
- **Translation Loading Fix**: Fixed WordPress compatibility issue with translation loading
  - Moved plugin initialization from 'plugins_loaded' to 'init' hook
  - Prevents "_load_textdomain_just_in_time" warnings about loading too early
  - Ensures proper WordPress initialization order and compatibility
  - Follows WordPress best practices for plugin initialization
- **Default Bot Image Update**: Changed default bot avatar and widget images
  - Updated default avatar from admin logo to public bot image
  - Updated default widget image from admin logo to public bot image
  - More appropriate default images for chatbot functionality
  - Consistent branding across admin and public interfaces
- **Message Styling Fixes**: Fixed poor message background colors and styling
  - Removed !important declarations that were causing black backgrounds
  - Added default values for message background colors (white for assistant, blue for user)
  - Added default values for message text colors (dark for assistant, white for user)
  - Improved readability and visual appeal of chat messages
  - Prevents CSS conflicts and ensures consistent styling
- **Directory Creation Error Handling**: Fixed chmod errors during plugin activation
  - Added proper error handling for directory creation operations
  - Added logging for failed directory and file creation attempts
  - Prevents chmod warnings when creating upload directories
  - More robust plugin activation process
- **Chatbot Creation Form Completion**: Fixed missing color fields causing black backgrounds
  - Added missing header color fields (background, font, icon colors)
  - Added fallback default values in AJAX handler for all color fields
  - Prevents new chatbots from being created with black backgrounds
  - Ensures proper default styling for new chatbots
  - New chatbots now have readable colors out of the box
- **JavaScript Modernization**: Upgraded from browser alerts to modern UI components
  - Replaced all JavaScript alert() calls with elegant toast notifications
  - Replaced confirm() dialogs with SweetAlert modern confirmations
  - Added comprehensive toast notification system with success, error, warning, and info types
  - Added SweetAlert library for beautiful confirmation dialogs
  - Improved user experience with modern, professional UI components
  - Toast notifications auto-dismiss with progress bars and manual close options
  - Mobile-responsive design for all notifications

### Changed
- **License Manager**: Improved remote validation handling
  - `check_extension_license()` no longer automatically updates local status
  - `maybe_validate_license()` only updates status when it actually changes
  - Better error handling for network and server issues
- **Admin Interface**: Enhanced license settings integration
  - Simplified AJAX flow with direct status updates
  - Improved user experience with immediate UI feedback
  - Better error handling and user feedback
- **License System Architecture**: Simplified to extension-only licensing
  - Removed `check_main_plugin_license()` method entirely
  - Updated `is_extension_licensed()` to only check extension license status
  - Updated `activate_extension_license()` to remove main plugin license requirement
  - Updated `show_license_notices()` to remove main plugin license notices
  - Updated `get_license_status_display()` to focus only on extension license
  - Removed main plugin license status from AJAX responses
- **Plugin Architecture**: Enhanced dependency management and user experience
  - Added runtime dependency checking to prevent plugin initialization without AI BotKit
  - Improved activation process with proper dependency validation
  - Added settings link to plugins page for easy access to license settings
  - Better user feedback for missing dependencies
  - Replaced fragile class-based dependency checks with robust plugin detection
  - Future-proof dependency checking that adapts to plugin structure changes
  - Refactored duplicate dependency checking functions into single reusable static method
- **Code Organization**: Improved code structure and maintainability
  - Separated concerns by moving styles and scripts to dedicated files
  - Eliminated inline styles and JavaScript from PHP templates
  - Centralized UI logic in proper CSS and JavaScript files
  - Better separation of presentation and business logic
- **License Validation Scheduling**: Improved license check efficiency
  - License validation only runs when license is manually activated
  - Automatic scheduling/unscheduling based on license status
  - Prevents unnecessary background processes when no license is active
  - Better resource management and performance

### Removed
- **Redundant AJAX Handler**: Removed `get_license_status_ajax()` method
- **Static Status Elements**: Removed conflicting static license status displays
- **Unnecessary Notice Logic**: Removed notices for valid license states
- **Main Plugin License Functionality**: Removed all main plugin license checking
  - Removed main plugin license status display from settings page
  - Removed main plugin license dependency checks from activation process
  - Removed main plugin license notices from admin interface
  - Removed main plugin license option key and related properties
  - Removed main plugin license status from AJAX responses
- **Duplicate Code**: Eliminated redundant dependency checking functions
  - Removed duplicate `is_ai_botkit_active()` methods from multiple classes
  - Centralized dependency checking logic in single static method
  - Reduced code duplication and improved maintainability
- **Inline Code**: Removed inline styles and JavaScript
  - Moved all inline styles from PHP template to dedicated CSS file
  - Moved all inline JavaScript from PHP template to dedicated JS file
  - Replaced browser alerts with modern toast notification system
  - Improved code organization and maintainability
- **Obsolete Functions**: Removed non-existent function calls
  - Removed call to undefined `initLicenseFormHandlers()` function
  - Fixed JavaScript errors that were preventing form functionality
  - Cleaned up obsolete code references

### Added
- **Plugin Dependency Validation**: Added comprehensive dependency checking
  - Activation-time dependency validation prevents plugin activation without AI BotKit
  - Runtime dependency checking prevents plugin initialization without AI BotKit
  - Clear error messages and admin notices for missing dependencies
- **Settings Page Integration**: Added easy access to license settings
  - Settings link in plugins page for quick access to license management
  - Link only appears when AI BotKit is active and accessible
  - Direct navigation to AI BotKit extension license tab
- **Toast Notification System**: Added modern user feedback system
  - Elegant toast notifications replacing browser alerts
  - Multiple notification types (success, error, warning, info)
  - Auto-dismiss with progress bar and manual close option
  - Smooth animations and responsive design
  - Global availability for use across the plugin
- **Enhanced Form Handling**: Improved license form functionality
  - Proper form submission with AJAX
  - Loading states and button management
  - Dynamic status updates without page reload
  - Better error handling and user feedback 